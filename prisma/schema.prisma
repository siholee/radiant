// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

enum UserRole {
  ADMIN
  PARTNER
  LIGHT
  EMPLOYEE
  USER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ==========================================
// Blog Creator Feature - New Enums
// ==========================================

enum ApiKeyProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  AZURE_OPENAI
}

enum ApiKeyStatus {
  ACTIVE
  DEPRECATED
  REVOKED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum SampleStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AiModelProvider {
  OPENAI
  GEMINI
  ANTHROPIC
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Email verification
  emailVerified     Boolean   @default(false)
  emailVerifyToken  String?
  emailVerifyExpiry DateTime?

  // Password reset
  resetToken        String?
  resetTokenExpiry  DateTime?

  // Login security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // Relations
  blogPosts     BlogPost[]
  employeeTasks EmployeeTask[]
  sessions      Session[]
  
  // Blog Creator Relations
  apiKeys              UserApiKey[]
  writingStyleProfiles WritingStyleProfile[]
  blogGenerationJobs   BlogGenerationJob[]
  layoutTemplates      BlogLayoutTemplate[]
  heroBanners          HeroBanner[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // LOGIN, LOGOUT, FAILED_LOGIN, PASSWORD_RESET, REGISTER, etc.
  ipAddress String?
  userAgent String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model BlogPost {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  content     String      @db.Text
  excerpt     String?
  coverImage  String?
  status      BlogStatus  @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Metadata
  locale      String      @default("ko") // 'ko' or 'en'
  tags        String[]    // Array of tags
  
  // SEO Optimization Fields
  metaDescription String?  @db.VarChar(160)  // SEO meta description (max 160 chars)
  faqSchema       Json?    // FAQ structured data for rich snippets
  readingTime     Int?     // Estimated reading time in minutes
  
  // AI Quality Management
  seoScore        Int?     @default(0)  // SEO quality score (0-100)
  aiDetectionScore Int?    @default(0)  // AI detection risk score (0-100, lower is better)
  qualityWarning  Boolean  @default(false)  // True if quality check failed after max iterations
  
  // AI Generation metadata
  generatedBy String?     // 'crewai' or 'manual'
  promptUsed  String?     @db.Text
  
  // Relations
  authorId    String
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Blog Generation Job reference
  generationJob BlogGenerationJob?

  @@index([status, publishedAt])
  @@index([locale, status])
  @@index([authorId])
  @@map("blog_posts")
}

model EmployeeTask {
  id          String      @id @default(cuid())
  title       String
  description String?     @db.Text
  status      TaskStatus  @default(TODO)
  priority    Int         @default(0) // Higher number = higher priority
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  assigneeId  String
  assignee    User        @relation(fields: [assigneeId], references: [id], onDelete: Cascade)

  @@index([status, assigneeId])
  @@index([dueDate])
  @@map("employee_tasks")
}

// ==========================================
// Blog Creator Feature - New Models
// ==========================================

model UserApiKey {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  provider     ApiKeyProvider
  encryptedKey String         @db.Text // AES-256-GCM encrypted
  keyVersion   Int            @default(1) // Encryption key version
  label        String?        // User-friendly name
  
  status       ApiKeyStatus   @default(ACTIVE)
  deprecatedAt DateTime?
  revokedAt    DateTime?
  
  lastUsedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // Relations
  usageLogs    ApiKeyUsage[]
  
  @@unique([userId, provider]) // One key per provider per user
  @@index([userId, status])
  @@map("user_api_keys")
}

model ApiKeyUsage {
  id            String      @id @default(cuid())
  keyId         String
  key           UserApiKey  @relation(fields: [keyId], references: [id], onDelete: Cascade)
  
  // Token usage
  inputTokens   Int         @default(0)
  outputTokens  Int         @default(0)
  totalTokens   Int         @default(0)
  
  // Cost tracking
  estimatedCost Float       @default(0) // in USD
  
  // Performance metrics
  responseTime  Int?        // milliseconds
  success       Boolean     @default(true)
  errorMessage  String?
  
  // Request context
  model         String?     // e.g., "gpt-4o", "claude-3-5-sonnet"
  purpose       String?     // e.g., "blog_generation", "embedding"
  
  timestamp     DateTime    @default(now())
  
  @@index([keyId, timestamp])
  @@index([timestamp])
  @@map("api_key_usage")
}

model WritingStyleProfile {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  
  // Style characteristics (extracted from samples)
  styleMetadata Json?   // { tone, vocabulary, structure, etc. }
  
  // Aggregate embedding for quick matching
  embedding   Unsupported("vector(1536)")?
  
  // AI Model preference
  preferredAiModel AiModelProvider @default(OPENAI)
  
  // AI Agent configuration (stored on model)
  openerAi    String  @default("openai")   // opener AI provider
  researchAi  String  @default("perplexity") // research AI provider
  editorAi    String  @default("openai")   // editor AI provider
  
  // Version management
  version        Int      @default(1)
  versionHistory Json?    // Array<{version, snapshot, changes, timestamp, userId}>
  
  // Marketplace & Sharing
  isPublic       Boolean  @default(false)
  usageCount     Int      @default(0)
  previewSample  String?  @db.Text
  previewGeneratedAt DateTime?
  
  isActive    Boolean  @default(true)
  sampleCount Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  samples     WritingSample[]
  
  @@index([userId, isActive])
  @@index([isPublic, isActive])
  @@map("writing_style_profiles")
}

model WritingSample {
  id          String              @id @default(cuid())
  profileId   String
  profile     WritingStyleProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Original content
  title       String?
  content     String              @db.Text
  sourceUrl   String?             // Original blog post URL
  
  // Metadata
  wordCount   Int
  language    String              @default("ko")
  platform    String?             // "naver", "wordpress", "medium", etc.
  
  // Vector embedding for RAG
  embedding   Unsupported("vector(1536)")?
  
  // Processing status for real-time tracking
  status         SampleStatus @default(PENDING)
  progress       Int          @default(0)  // 0-100
  processingStep String?      // Current step description
  errorMessage   String?      @db.Text
  retryCount     Int          @default(0)  // Max 3 retries
  
  // Quality validation
  qualityScore     Int?       // 0-100
  validationIssues Json?      // { issues: string[], warnings: string[] }
  
  // Quality/relevance
  isApproved  Boolean             @default(true)
  
  createdAt   DateTime            @default(now())
  processedAt DateTime?
  
  @@index([profileId, isApproved])
  @@index([profileId, status])
  @@map("writing_samples")
}

model BlogGenerationJob {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Input
  prompt        String      @db.Text
  title         String?
  locale        String      @default("ko")
  tags          String[]
  
  // Style profile reference
  styleProfileId String?
  
  // Processing
  status        JobStatus   @default(PENDING)
  progress      Int         @default(0) // 0-100
  currentStep   String?     // Current processing step description
  steps         Json?       // Array of completed steps with timestamps
  
  // Output
  blogPostId    String?     @unique
  blogPost      BlogPost?   @relation(fields: [blogPostId], references: [id])
  
  // Metadata
  errorMessage  String?     @db.Text
  processingTime Int?       // seconds
  
  // AI model used
  aiModel       String?     // e.g., "gpt-4o", "claude-3-5-sonnet"
  aiProvider    ApiKeyProvider?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  completedAt   DateTime?
  
  @@index([userId, status])
  @@index([status, createdAt])
  @@map("blog_generation_jobs")
}

// User's saved blog links (for reference, not training)
model UserBlogLink {
  id          String   @id @default(cuid())
  userId      String
  
  title       String
  url         String
  platform    String   // "naver", "wordpress", "tistory", etc.
  publishedAt DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, platform])
  @@map("user_blog_links")
}

// ==========================================
// Blog Layout Template System
// ==========================================

model BlogLayoutTemplate {
  id          String   @id @default(cuid())
  userId      String?  // null = system default template
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String   @db.VarChar(50)
  description String?  @db.VarChar(200)
  
  // Layout instruction for AI (replaces hardcoded structure in writer_stage)
  promptInstruction String @db.Text
  
  // Template metadata
  isSystem    Boolean  @default(false)  // System templates cannot be edited/deleted
  isPublic    Boolean  @default(false)  // Public templates can be forked by others
  isActive    Boolean  @default(true)
  
  // Usage tracking
  usageCount  Int      @default(0)
  
  // Test preview
  previewSample      String?   @db.Text
  previewGeneratedAt DateTime?
  
  // Sorting
  sortOrder   Int      @default(0)
  
  // Version management
  version        Int      @default(1)
  versionHistory Json?    // Array<{version, snapshot, changes, timestamp, userId}>
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, isActive])
  @@index([isPublic, isActive])
  @@map("blog_layout_templates")
}

// ==========================================
// Homepage Management - Hero Banner
// ==========================================

model HeroBanner {
  id          String   @id @default(cuid())
  imageUrl    String
  linkUrl     String?
  title       String?
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdBy   String
  user        User     @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@map("hero_banners")
}
